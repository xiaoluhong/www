<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Set up K3s in High Availability using k3d | IT老男孩</title><meta name="keywords" content="IT老男孩,rancher,github rancher,rke,rke2,k3s,docker,kubernetes,devops,多集群管理,容器,Linux运维,网络运维,最佳实践"><meta name="author" content="IT老男孩"><meta name="copyright" content="IT老男孩"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文永久链接: https:&#x2F;&#x2F;www.xtplayer.cn&#x2F;k3s&#x2F;set-up-k3s-in-high-availability-using-k3d&#x2F;    Have you ever wanted to try K3s high availability cluster “mode,” and you either did not have the minimum three “spare"><meta property="og:type" content="article"><meta property="og:title" content="Set up K3s in High Availability using k3d"><meta property="og:url" content="https://www.xtplayer.cn/k3s/set-up-k3s-in-high-availability-using-k3d/index.html"><meta property="og:site_name" content="IT老男孩"><meta property="og:description" content="本文永久链接: https:&#x2F;&#x2F;www.xtplayer.cn&#x2F;k3s&#x2F;set-up-k3s-in-high-availability-using-k3d&#x2F;    Have you ever wanted to try K3s high availability cluster “mode,” and you either did not have the minimum three “spare"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.xtplayer.cn/img/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2021-02-26T14:56:15.000Z"><meta property="article:modified_time" content="2021-03-23T14:58:20.000Z"><meta property="article:author" content="IT老男孩"><meta property="article:tag" content="IT老男孩,rancher,github rancher,rke,rke2,k3s,docker,kubernetes,devops,多集群管理,容器,Linux运维,网络运维,最佳实践"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.xtplayer.cn/img/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" type="image/png" href="/img/favicon.png"><link rel="canonical" href="https://www.xtplayer.cn/k3s/set-up-k3s-in-high-availability-using-k3d/"><link rel="preconnect" href="https//cdn.jsdelivr.net"><link rel="preconnect" href="https//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="https//hm.baidu.com"><link rel="preconnect" href="https//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet preload" as="font" href="/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="/css/snackbar.min.css" media="print" onload='this.media="all"'><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4244806813321801",enable_page_level_ads:"true"})</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?08d495d3996be233cf4355e47874fd02";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-WDVQSZ43MX"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WDVQSZ43MX")</script><script>!function(){var c=document.createElement("script");c.src="https://sf1-scmcdn-tos.pstatp.com/goofy/ttzz/push.js?abca38a75f1ee646121b4cdefd4e13ce89e669412cb977bb98b66029e7fc3cfc8d38a1f1352cfca035e8cdfca27dc395b6c71280cecfa54b697791769b400b8d",c.id="ttzz";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(c,e)}(window)</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-center"},source:{jQuery:"/js/jquery.min.js",justifiedGallery:{js:"/js/jquery.justifiedGallery.min.js",css:"/css/justifiedGallery.min.css"},fancybox:{js:"/js/jquery.fancybox.min.js",css:"/css/jquery.fancybox.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isanchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2021-03-23 22:58:20"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)});const t=saveToLocal.get("aside-status");void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"))})(window)</script><style>#toggle-sidebar{left:100px}</style><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="IT老男孩" type="application/atom+xml"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpeg" onerror='onerror=null,src="/img/friend_404.gif"' width="110px" height="110px" alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">132</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">96</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div><div class="menus_item"><a class="site-page" href="/ad/"><i class="fa-fw fas fa-heart"></i> <span>广告</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">IT老男孩</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div><div class="menus_item"><a class="site-page" href="/ad/"><i class="fa-fw fas fa-heart"></i> <span>广告</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div class="ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4244806813321801" data-ad-slot="4594418186" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div id="post-info"><h1 class="post-title">Set up K3s in High Availability using k3d</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表:</span> <time class="post-meta-date-created" datetime="2021-02-26T14:56:15.000Z" title="发表 2021-02-26 22:56:15">2021-02-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新:</span> <time class="post-meta-date-updated" datetime="2021-03-23T14:58:20.000Z" title="更新 2021-03-23 22:58:20">2021-03-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><span class="post-meta-label">分类:</span> <a class="post-meta-categories" href="/categories/k3s/">k3s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span> <span class="word-count">2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span> <span>12分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="Set up K3s in High Availability using k3d"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><p><span>本文永久链接:</span><i class="fa fa-creative-commons"></i> <a rel="noopener external nofollow noreferrer" href="https://www.xtplayer.cn/k3s/set-up-k3s-in-high-availability-using-k3d/" target="_blank" title="https://www.xtplayer.cn/k3s/set-up-k3s-in-high-availability-using-k3d/">https://www.xtplayer.cn/k3s/set-up-k3s-in-high-availability-using-k3d/</a></p><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d-featured.png" title="Set up K3s in High Availability using k3d"><p>Have you ever wanted to try K3s high availability cluster “mode,” and you either did not have the minimum three “spare nodes” or the time required to set up the same amount of VMs? Then you are in for a good treat: meet k3d!</p><p>If you’re not familiar with k3d, its name gives you a hint to what it’s all about: K3s in Docker. <a target="_blank" rel="noopener external nofollow noreferrer" href="https://k3d.io/">k3d</a> is a lightweight wrapper to run <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/rancher/k3s">K3s</a> (a lightweight, single &lt;40MB binary, certified Kubernetes distribution developed by Rancher Labs and now a CNCF sandbox project) in Docker. With k3d, it’s easy to create single- and multi-node <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/rancher/k3s">K3s</a> clusters in Docker, for local development on Kubernetes.</p><p>k3d allows you to start a K3s cluster in literally no time. Plus, you can learn its few, but powerful, commands very quickly. k3d runs in Docker, which allows you to scale up and scale down nodes without further setup. In this blog, we’ll cover setting up a single-node K3s cluster using k3d and then walk through the steps for setting up K3s in high availability mode using k3d.</p><p>The two main objectives of this blog are to provide an introduction to k3d as a tool for deploying K3s clusters and to show how K3s high availability resists “nodes degradation.” As a bonus, we’ll look at which components K3s deploys in a cluster by default.</p><h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>All of you have a preference when it comes to OS (Linux, MacOS, Windows). So, before we check the setup used for this blog post, there are only two mandatory requirements: Docker and a Linux shell.</p><p>If you are on MacOS or Windows, Docker Desktop is the preferred solution for Docker. For Linux, you can get the Docker engine and CLIs as described <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.docker.com/products/docker-desktop">here</a>.</p><p>Concerning the Linux shell, MacOS and Linux are covered. For Windows, the easiest and fastest solution is WSL2, which we’ll use in this demo.</p><p>Here is the setup that we’ll use:</p><p>OS: Windows 10 version 2004 (build: 19041)</p><ul><li>OS components: Virtual Machine Platform and Windows Subsystem for Linux<ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">Installation steps</a></li></ul></li><li>WSL2 distro: Ubuntu<ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.microsoft.com/en-us/p/ubuntu/9nblggh4msv6">Windows store link</a></li></ul></li><li>[Optional] Console used: Windows Terminal<ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.microsoft.com/en-us/p/windows-terminal/9n0dx20hk701">Windows store link</a></li></ul></li></ul><h3 id="Step-1-Start-with-Installation"><a href="#Step-1-Start-with-Installation" class="headerlink" title="Step 1: Start with Installation"></a>Step 1: Start with Installation</h3><p>The k3d installation process is well documented <a target="_blank" rel="noopener external nofollow noreferrer" href="https://k3d.io/#installation">here</a>.</p><p>For this blog post, we’ll use the “curl” installation.</p><p><strong>Attention:</strong> <em>running scripts directly from a URL is a big security no-no. So before running any script, ensure that the source is the project’s website and&#x2F;or git online repository. And even if you trust the source, reviewing the script is never too much.</em></p><p>Here are the installation steps:</p><p>Go to <a target="_blank" rel="noopener external nofollow noreferrer" href="https://k3d.io/#installation">https://k3d.io/#installation</a></p><ul><li>Copy the “curl” installation command and run it inside your terminal <code>curl -s https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash</code> <img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_01.png" title="Image 01"></li></ul><p><strong>Note</strong>: this screenshot shows two more commands: <code>k3d version</code>: <em>provides which version of k3d has been installed</em> <code>k3d --help</code>: <em>lists the commands that can be used with k3d</em></p><p>Now k3d is installed and ready to use.</p><h2 id="Step-2-Start-Small-with-a-Single-Node-Cluster"><a href="#Step-2-Start-Small-with-a-Single-Node-Cluster" class="headerlink" title="Step 2: Start Small with a Single-Node Cluster"></a>Step 2: Start Small with a Single-Node Cluster</h2><p>Before we create an HA cluster, let’s start with a one-node cluster in order to understand the commands (“grammar”) and see what k3d deploys by default.</p><p>First, the grammar. In v3, k3d made a big switch in how to use commands. We won’t delve into how commands were done before; we’ll use the syntax of v3.</p><p>The k3s commands follows a “noun + verb” syntax. First specify <em>what</em> we want to use (cluster or node) and then which <em>action</em> we want to apply (create, delete, start, stop).</p><h3 id="Create-a-one-node-cluster"><a href="#Create-a-one-node-cluster" class="headerlink" title="Create a one-node cluster"></a>Create a one-node cluster</h3><p>To create our first cluster with k3d, we’ll create one with no options, using only the defaults:</p><p><code>k3d cluster create</code> <img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_02.png" title="Image 02"></p><p><strong>Note:</strong> the output of the <em>k3d cluster create command suggests running another command to check that the cluster is running and accessible:</em> kubectl cluster-info</p><p>Now the cluster is up and running! That was fast, right?</p><h3 id="Sneak-peek-at-internals"><a href="#Sneak-peek-at-internals" class="headerlink" title="Sneak peek at internals"></a>Sneak peek at internals</h3><p>One optional task that we can do is to see what exactly is deployed from <em>various</em> points of view.</p><p>Let’s start from the top and look at what’s inside the K3s cluster (pods, services, deployments, etc.): <code>kubectl get all --all-namespaces</code> <img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_03.png" title="Image 03"></p><p>We can see that, in addition of the <strong>Kubernetes</strong> service, K3s deploys DNS, metrics and ingress (traefik) services when we use the defaults.</p><p>Now let’s look at the nodes from different points of view.</p><p>First, we’ll check it from a cluster perspective:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get nodes --output wide</span><br></pre></td></tr></table></figure><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_04.png" title="Image 04"><p>As expected, we only see one node. Now let’s see it from k3d’s perspective:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">k3d node list</span><br></pre></td></tr></table></figure><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_05.png" title="Image 05"><p>Now we have two nodes. The (very) smart implementation here is that while the cluster is running on its node <strong>k3d-k3s-default-server-0</strong> , there is another “node” that acts as the load balancer. While this might not be useful for a single-node cluster, it will save us a lot of effort in our HA cluster.</p><p>Finally, we can see the two nodes from Docker: <code>docker ps</code> <img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_06.png" title="Image 06"></p><h3 id="Cleaning-the-resources"><a href="#Cleaning-the-resources" class="headerlink" title="Cleaning the resources"></a>Cleaning the resources</h3><p>Our one-node cluster helped us understand the mechanics and commands of k3d. Let’s clean up the resource before deploying our HA cluster. <code>k3d cluster delete</code> <img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_07.png" title="Image 07"></p><p><strong>Note:</strong> for demo purposes, we added the following commands to the screenshot above:</p><p><code>k3d cluster list</code>: List the active k3d clusters <code>kubectl cluster-info</code>: Check the cluster connectivity</p><p><code>docker ps</code>: Check the active containers</p><p>Now we’ve created, checked and deleted a single-node cluster with k3d. In the next step, we’ll have fun with HA.</p><h2 id="Step-3-Welcome-to-the-HA-World"><a href="#Step-3-Welcome-to-the-HA-World" class="headerlink" title="Step 3: Welcome to the HA World"></a>Step 3: Welcome to the HA World</h2><p>Before we jump into the command line, let’s get a basic understanding of what we’ll launch and mention a few additional requirements.</p><p>First, Kubernetes HA has <a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">two possible setups</a>: embedded or external database (DB). We’ll use the <strong>embedded DB</strong> setup.</p><p>Second, K3s has two different technologies for <a target="_blank" rel="noopener external nofollow noreferrer" href="https://rancher.com/docs/k3s/latest/en/installation/ha-embedded/">HA with an embedded DB</a>: one based on <strong>dqlite</strong> (K3s v1.18) and another on <strong>etcd</strong> (K3S v1.19+).</p><p>This means <strong>etcd</strong> is the default in the current K3s stable release and is the one which will be used in this blog. <strong>dqlite</strong> has been deprecated.</p><p>At the time of this writing, k3d was using K3s version v1.18.9-k3s1 by default. You can check this by running <code>k3d version</code>: <img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_08.png" title="Image 08"></p><p>Does this mean we need to reinstall k3d with a version that supports K3s v1.19? The answer is no!</p><p>We can use our current installed version of k3d and still have K3s v1.19 support, thanks to the following reasons:</p><ul><li>k3d has an option where we can specify a particular K3s docker image to be used.</li><li>All K3s versions are published as container images, too.</li></ul><p>Based on the two reasons above, we can assume a K3s v1.19 exists as a container image stored in Docker Hub.</p><p>As a helper, <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hub.docker.com/r/rancher/k3s/tags?page=1&name=v1.19">here is the search link</a>.</p><p>Enough with the theory. Let’s create our first K3s HA cluster with k3d.</p><h3 id="The-triumvirate-control-planes"><a href="#The-triumvirate-control-planes" class="headerlink" title="The triumvirate control planes"></a>The triumvirate control planes</h3><p>As Kubernetes HA best practices <a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/docs/tasks/administer-cluster/highly-available-master/#best-practices-for-replicating-masters-for-ha-clusters">strongly recommend</a>, we should create an HA cluster with at least three control plane nodes.</p><p>We can achieve that with k3d in one command:</p><p><code>k3d cluster create --servers 3 --image rancher/k3s:v1.19.3-k3s2</code> <img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_09.png" title="Image 09"></p><p><strong>Learning the command:</strong> <em>Base command:</em> <code>k3d cluster create</code> Options:</p><p>–<code>server 3</code>: <em>requests three nodes to be created with the role server</em></p><p>–<code>image rancher/k3s:v1.19.3-k3s2</code>: <em>specifies the K3S image to be used</em></p><p>We can now check what has been created from the different points of view:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get nodes --output wide</span><br></pre></td></tr></table></figure><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_10.png" title="Image 10"><p>As seen here, we checked from the different points of view to ensure our nodes are correctly running.</p><p>If we look at the components deployed, our <strong>daemonset</strong> now has three replicas instead of one:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get all --all-namespaces</span><br></pre></td></tr></table></figure><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_11.png" title="Image 11"><p>One last check is to see on which node the <strong>pods</strong> are running:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get podes --all-namespaces --output wide</span><br></pre></td></tr></table></figure><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_12.png" title="Image 12"><p>Now we have the base of our HA cluster. Let’s add an additional control plane node, bring some “destruction” and see how the cluster behaves.</p><h3 id="Scale-up-the-cluster"><a href="#Scale-up-the-cluster" class="headerlink" title="Scale up the cluster"></a>Scale up the cluster</h3><p>Thanks to k3d and the fact our cluster runs on top of containers, we can quickly simulate the addition of another control plane node to the HA cluster:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">k3d node create extraCPnode --role=server --image=rancher/k3s:v1.19.3-k3s2</span><br></pre></td></tr></table></figure><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_13.png" title="Image 13"><p><strong>Learning the command:</strong> <em>Base command:</em> <code>k3d node create</code> <em>Options:</em></p><p><code>extraCPnode</code>: <em>base name that k3d will use to create the final node name</em></p><p><code>role=server</code>: <em>sets the role for the node to be a control plane</em></p><p><code>image rancher/k3s:v1.19.3-k3s2</code>: <em>specifies the K3s image to be used</em></p><p>As seen here, we checked from the different points of view to ensure our new control plane node is running correctly.</p><p>With this additional node added, we can perform our final test: bring down the <strong>node0</strong>!</p><h3 id="HA-Heavy-Armored-against-crashes"><a href="#HA-Heavy-Armored-against-crashes" class="headerlink" title="HA: Heavy Armored against crashes"></a>HA: Heavy Armored against crashes</h3><p>There are various reasons that this test is one of the most sensible. The <strong>node0</strong> is normally the one that our <em>KUBECONFIG</em> refers to (in terms of IP or hostname), and therefore our kubectl application tries to connect to for running the different commands.</p><p>As we are working with containers, the best way to “crash” a node is to literally stop the container:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker stop k3d-k3s-default-server-0</span><br></pre></td></tr></table></figure><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_14.png" title="Image 14"><p><strong>Note:</strong> <em>The Docker and k3d commands will show the state change immediately. However, the Kubernetes (read: K8s or K3s) cluster needs a short time to see the state change to NotReady.</em></p><p>And like magic, our cluster still responds to our commands using kubectl.</p><p>Now it is a good time to reference again the <strong>load balancer</strong> k3d uses and how it is critical in allowing us to continue accessing the K3s cluster.</p><p>While the load balancer internally switched to the next available node, from an external connectivity point of view, we still use the same IP&#x2F;host. This abstraction saves us quite some efforts and it’s one of the most useful features of k3d.</p><p>Let’s look at the state of the cluster:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get all --all-namespaces</span><br></pre></td></tr></table></figure><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_15.png" title="Image 15"><p>Everything looks right. If we look at the pods more specifically, then we will see that K3s automatically self-healed by recreating pods running on the failed node on other nodes:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get pods --all-namespaces --output wide</span><br></pre></td></tr></table></figure><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_16.png" title="Image 16"><p>Finally, to show the power of HA and how K3s manages it, let’s restart the <strong>node0</strong> and see it being re-included into the cluster as if nothing happened:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker start k3d-k3s-default-server-0</span><br></pre></td></tr></table></figure><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_17.png" title="Image 17"><p>Our cluster is stable, and all the nodes are fully operational again.</p><h3 id="Cleaning-the-resources-once-again"><a href="#Cleaning-the-resources-once-again" class="headerlink" title="Cleaning the resources, once again"></a>Cleaning the resources, once again</h3><p>Now we can delete our local HA cluster, as it has served its purpose. Plus, we know that we can create a new one just like that.</p><p>Let’s clean up the resource our HA cluster used : <code>k3d cluster delete</code></p><img src="/k3s/set-up-k3s-in-high-availability-using-k3d/k3d_18.png" title="Image 18"><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>While we created a single node and an HA cluster locally, inside containers, we can still see how K3s behaves with the new etcd embedded DB. If we deployed K3s on bare metal or virtual machines, it would act the same way.</p><p>That being said, k3d helped a lot in terms of management. It created a load balancer by default that allowed permanent connectivity to the K3s cluster while abstracting all the tasks that we would have done manually if it was <a target="_blank" rel="noopener external nofollow noreferrer" href="https://rancher.com/blog/2020/k3s-high-availability">deployed outside containers</a>.</p><p>In this post, we’ve seen how easy it is to set up high availability K3s clusters using k3d. If you haven’t tried K3s or k3d, what are you waiting for? They are both free and easy to use.</p><p>Thanks for reading!</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">IT老男孩</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://www.xtplayer.cn/k3s/set-up-k3s-in-high-availability-using-k3d/">https://www.xtplayer.cn/k3s/set-up-k3s-in-high-availability-using-k3d/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a rel="noopener noreferrer" href="https://www.xtplayer.cn" target="_blank">IT老男孩</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/"><img class="prev-cover" src="/img/gkihqEjXxJ5UZ1C.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Using Hybrid and Multi-Cloud Service Mesh Based Applications for Distributed Deployments</div></div></a></div><div class="next-post pull-right"><a href="/rancher/compute-confidently-at-the-edge-with-rancher-and-longhorn-1-1/"><img class="next-cover" src="/img/gkihqEjXxJ5UZ1C.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Compute Confidently at the Edge with Rancher and Longhorn</div></div></a></div></nav><div class="ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4244806813321801" data-ad-slot="9845679202" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpeg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' width="110px" height="110px" alt="avatar"><div class="author-info__name">IT老男孩</div><div class="author-info__description">IT老男孩 - 原名系统玩家，分享 IT 相关技术文章，分享工作中的最佳实践。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">132</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">96</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/rancher"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xiaoluhong" target="_blank" rel="external nofollow noreferrer noopener" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1044281310@qq.com" target="_blank" rel="external nofollow noreferrer noopener" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">我的博客</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录导航</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prerequisites"><span class="toc-number">1.</span> <span class="toc-text">Prerequisites</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-1-Start-with-Installation"><span class="toc-number">1.1.</span> <span class="toc-text">Step 1: Start with Installation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2-Start-Small-with-a-Single-Node-Cluster"><span class="toc-number">2.</span> <span class="toc-text">Step 2: Start Small with a Single-Node Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Create-a-one-node-cluster"><span class="toc-number">2.1.</span> <span class="toc-text">Create a one-node cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sneak-peek-at-internals"><span class="toc-number">2.2.</span> <span class="toc-text">Sneak peek at internals</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cleaning-the-resources"><span class="toc-number">2.3.</span> <span class="toc-text">Cleaning the resources</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3-Welcome-to-the-HA-World"><span class="toc-number">3.</span> <span class="toc-text">Step 3: Welcome to the HA World</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-triumvirate-control-planes"><span class="toc-number">3.1.</span> <span class="toc-text">The triumvirate control planes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Scale-up-the-cluster"><span class="toc-number">3.2.</span> <span class="toc-text">Scale up the cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HA-Heavy-Armored-against-crashes"><span class="toc-number">3.3.</span> <span class="toc-text">HA: Heavy Armored against crashes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cleaning-the-resources-once-again"><span class="toc-number">3.4.</span> <span class="toc-text">Cleaning the resources, once again</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/rancher/waiting-for-node-to-register-either-cluster-is-not-ready-for-registering-or-etcd-and-controlplane-node-have-to-be-registered-first/" title="Waiting for node to register. Either cluster is not ready for registering or etcd and controlplane node have to be registered first">Waiting for node to register. Either cluster is not ready for registering or etcd and controlplane node have to be registered first</a><time datetime="2022-09-17T06:33:50.000Z" title="发表 2022-09-17 14:33:50">2022-09-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/mysql/how-to-get-the-sizes-of-the-tables-of-a-mysql-database/" title="如何查看 MySQL 数据库容量大小，表容量大小，索引容量大小？">如何查看 MySQL 数据库容量大小，表容量大小，索引容量大小？</a><time datetime="2022-05-17T08:48:50.000Z" title="发表 2022-05-17 16:48:50">2022-05-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/rancher/either-cluster-is-not-ready-for-registering/" title="node-agent 报错 Either cluster is not ready for registering, cluster is currently provisioning, or etcd, controlplane and worker node have to be registered">node-agent 报错 Either cluster is not ready for registering, cluster is currently provisioning, or etcd, controlplane and worker node have to be registered</a><time datetime="2022-05-14T05:13:09.000Z" title="发表 2022-05-14 13:13:09">2022-05-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/prometheus/prometheus-adapter/" title="Prometheus Adapter 安装">Prometheus Adapter 安装</a><time datetime="2022-04-04T08:26:12.000Z" title="发表 2022-04-04 16:26:12">2022-04-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/prometheus/custom-parameter/" title="自定义集群监控参数">自定义集群监控参数</a><time datetime="2022-03-28T11:10:20.000Z" title="发表 2022-03-28 19:10:20">2022-03-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/rancher/rancher-new-forums/" title="全新论坛启用，Rancher 中文社区迈入新阶段">全新论坛启用，Rancher 中文社区迈入新阶段</a><time datetime="2022-03-25T13:16:03.000Z" title="发表 2022-03-25 21:16:03">2022-03-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/coredns/accelerate-external-domain-resolution/" title="coreDNS 加速外部域名解析">coreDNS 加速外部域名解析</a><time datetime="2021-07-17T05:12:27.000Z" title="发表 2021-07-17 13:12:27">2021-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/longhorn/ai-at-the-edge-with-k3s-nvidia-jetson-nano-object-detection-real-time-video-analytics-src/" title="AI at the Edge with K3s and NVIDIA Jetson Nano: Object Detection and Real-Time Video Analytics">AI at the Edge with K3s and NVIDIA Jetson Nano: Object Detection and Real-Time Video Analytics</a><time datetime="2021-04-20T16:22:57.000Z" title="发表 2021-04-21 00:22:57">2021-04-21</time></div></div></div></div><div class="card-widget ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4244806813321801" data-ad-slot="5141213090" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By IT老男孩</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn"><img class="icp-icon" width="25px" height="17px" src="/img/icp.png" alt="icp"><span>蜀ICP备20023095号-1</span></a> <a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51010702002006"><span>川公网安备51010702002006号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text" aria-label="Search"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/instantpage.min.js" type="module"></script><script src="/js/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="5169987169" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><link rel="stylesheet" href="/css/APlayer.min.css" media="print" onload='this.media="all"'><script src="/js/APlayer.min.js"></script><script src="/js/Meting.min.js"></script><script src="/js/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!0,scrollRestoration:!1});document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","G-WDVQSZ43MX",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:send",(function(){if("object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="/js/busuanzi.pure.mini.js"></script><script>!function(){var e=document.createElement("script");e.src="https://sf1-scmcdn-tos.pstatp.com/goofy/ttzz/push.js?abca38a75f1ee646121b4cdefd4e13cef04782c449861f0dbdffcd879911999e0ea61db5c17bca91cb6b39891e5c5ae8de9c557b8186e0f895b49e96a4810ca7",e.id="ttzz";var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}(window)</script></div></body></html>