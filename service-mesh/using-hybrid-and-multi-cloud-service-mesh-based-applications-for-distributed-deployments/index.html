<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Using Hybrid and Multi-Cloud Service Mesh Based Applications for Distributed Deployments | IT老男孩</title><meta name="keywords" content="IT老男孩,rancher,github rancher,rke,rke2,k3s,docker,kubernetes,devops,多集群管理,容器,Linux运维,网络运维,最佳实践"><meta name="author" content="IT老男孩"><meta name="copyright" content="IT老男孩"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文永久链接: https:&#x2F;&#x2F;www.xtplayer.cn&#x2F;service-mesh&#x2F;using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments&#x2F;    Service Mesh is an emerging architecture pattern gaining tract"><meta property="og:type" content="article"><meta property="og:title" content="Using Hybrid and Multi-Cloud Service Mesh Based Applications for Distributed Deployments"><meta property="og:url" content="https://www.xtplayer.cn/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/index.html"><meta property="og:site_name" content="IT老男孩"><meta property="og:description" content="本文永久链接: https:&#x2F;&#x2F;www.xtplayer.cn&#x2F;service-mesh&#x2F;using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments&#x2F;    Service Mesh is an emerging architecture pattern gaining tract"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.xtplayer.cn/img/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2021-02-26T14:57:52.000Z"><meta property="article:modified_time" content="2021-03-23T14:58:20.000Z"><meta property="article:author" content="IT老男孩"><meta property="article:tag" content="IT老男孩,rancher,github rancher,rke,rke2,k3s,docker,kubernetes,devops,多集群管理,容器,Linux运维,网络运维,最佳实践"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.xtplayer.cn/img/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" type="image/png" href="/img/favicon.png"><link rel="canonical" href="https://www.xtplayer.cn/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/"><link rel="preconnect" href="https//cdn.jsdelivr.net"><link rel="preconnect" href="https//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="https//hm.baidu.com"><link rel="preconnect" href="https//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet preload" as="font" href="/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="/css/snackbar.min.css" media="print" onload='this.media="all"'><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4244806813321801",enable_page_level_ads:"true"})</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?08d495d3996be233cf4355e47874fd02";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-WDVQSZ43MX"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WDVQSZ43MX")</script><script>!function(){var c=document.createElement("script");c.src="https://sf1-scmcdn-tos.pstatp.com/goofy/ttzz/push.js?abca38a75f1ee646121b4cdefd4e13ce89e669412cb977bb98b66029e7fc3cfc8d38a1f1352cfca035e8cdfca27dc395b6c71280cecfa54b697791769b400b8d",c.id="ttzz";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(c,e)}(window)</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-center"},source:{jQuery:"/js/jquery.min.js",justifiedGallery:{js:"/js/jquery.justifiedGallery.min.js",css:"/css/justifiedGallery.min.css"},fancybox:{js:"/js/jquery.fancybox.min.js",css:"/css/jquery.fancybox.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isanchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2021-03-23 22:58:20"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)});const t=saveToLocal.get("aside-status");void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"))})(window)</script><style>#toggle-sidebar{left:100px}</style><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="IT老男孩" type="application/atom+xml"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpeg" onerror='onerror=null,src="/img/friend_404.gif"' width="110px" height="110px" alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">132</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">96</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div><div class="menus_item"><a class="site-page" href="/ad/"><i class="fa-fw fas fa-heart"></i> <span>广告</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">IT老男孩</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div><div class="menus_item"><a class="site-page" href="/ad/"><i class="fa-fw fas fa-heart"></i> <span>广告</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div class="ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4244806813321801" data-ad-slot="4594418186" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div id="post-info"><h1 class="post-title">Using Hybrid and Multi-Cloud Service Mesh Based Applications for Distributed Deployments</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表:</span> <time class="post-meta-date-created" datetime="2021-02-26T14:57:52.000Z" title="发表 2021-02-26 22:57:52">2021-02-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新:</span> <time class="post-meta-date-updated" datetime="2021-03-23T14:58:20.000Z" title="更新 2021-03-23 22:58:20">2021-03-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><span class="post-meta-label">分类:</span> <a class="post-meta-categories" href="/categories/service-mesh/">service-mesh</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span> <span class="word-count">3.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span> <span>22分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="Using Hybrid and Multi-Cloud Service Mesh Based Applications for Distributed Deployments"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><p><span>本文永久链接:</span><i class="fa fa-creative-commons"></i> <a rel="noopener external nofollow noreferrer" href="https://www.xtplayer.cn/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/" target="_blank" title="https://www.xtplayer.cn/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/">https://www.xtplayer.cn/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/</a></p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/mesh-featured.png" title="Using Hybrid and Multi-Cloud Service Mesh Based Applications for Distributed Deployments"><p>Service Mesh is an emerging architecture pattern gaining traction today. Along with Kubernetes, Service Mesh can form a powerful platform which addresses the technical requirements that arise in a highly distributed environment typically found on a microservices cluster and&#x2F;or service infrastructure. A Service Mesh is a dedicated infrastructure layer for facilitating service-to-service communications between microservices.</p><p>Service Mesh addresses the communication requirements typical in a microservices-based application, including encrypted tunnels, health checks, circuit breakers, load balancing and traffic permission. Leaving the microservices to address these requirements leads to an expensive and time consuming development process.</p><p>In this blog, we’ll provide an overview of the most common microservice communication requirements that the Service Mesh architecture pattern solves.</p><h2 id="Microservices-Dynamics-and-Intrinsic-Challenges"><a href="#Microservices-Dynamics-and-Intrinsic-Challenges" class="headerlink" title="Microservices Dynamics and Intrinsic Challenges"></a>Microservices Dynamics and Intrinsic Challenges</h2><p>The problem begins when you realize that microservices implement a considerable amount of code not related to the business logic they were originally assigned. Additionally, it’s possible you have multiple microservices implementing similar capabilities in a non-standardized process. In other words, the microservices development team should focus on business logic and leave the low-level communication capabilities to a specific layer.</p><p>Moving forward with our scenario, consider the intrinsic dynamics of microservices. In given time, you may (or most likely will) have multiple instances of a microservice due to several reasons, including:</p><ul><li>Throughput: depending on the incoming requests, you might have a higher or lower number of instances of a microservice</li><li>Canary release</li><li>Blue&#x2F;green deployment</li><li>A&#x2F;B testing</li></ul><p>In short, the microservice-to-microservice communication has specific requirements and issues to solve. The illustration below shows this scenario:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_01.png" title="Image 01"><p>The illustration depicts several technical challenges. Clearly, one of the main responsibilities of Microservice 1 is to balance the load among all Microservice 2 instances. As such, Microservice 1 has to figure out how many Microservice 2 instances we have at the request moment. In other words, Microservice 1 must implement service discovery and load balancing.</p><p>On the other hand, Microservice 2 has to implement some service registration capabilities to tell Microservice 1 when a brand-new instance is available.</p><p>In order to have a fully dynamic environment, these other capabilities should be part of the microservices development:</p><ul><li>Traffic control: a natural evolution of load balancing. We want to specify the number of requests that should go to each of the Microservice 2 instances.</li><li>Encrypted communication between the Microservices 1 and 2.</li><li>Circuit breakers and health checks to address and overcome networking problems.</li></ul><p>In conclusion, the main problem is that the development team is spending significant resources writing complex code not directly related to business logic expected to be delivered by the microservices.</p><h2 id="Potential-Solutions"><a href="#Potential-Solutions" class="headerlink" title="Potential Solutions"></a>Potential Solutions</h2><p>How about externalizing all the non-functional and operational capabilities in an external and standardized component that all microservices can call? For example, the diagram below compiles all capabilities that should not be part of a given microservice. So, after identifying all capabilities, we need to decide where to implement them.</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_02.png" title="Image 02"><h3 id="Solution-1-Encapsulating-all-capabilities-in-a-library"><a href="#Solution-1-Encapsulating-all-capabilities-in-a-library" class="headerlink" title="Solution #1 - Encapsulating all capabilities in a library"></a>Solution #1 - Encapsulating all capabilities in a library</h3><p>The developers would be responsible for calling functions provided by the library to address the microservice communication requirements.</p><p>There are a few drawbacks to this solution:</p><ul><li>It’s a tightly coupled solution, meaning that the microservices are highly dependent on the library.</li><li>It’s not an easy model to distribute or upgrade new versions of the library.</li><li>It doesn’t fit the microservice polyglot principle with different programming languages being applied on different contexts</li></ul><h3 id="Solution-2-Transparent-Proxy"><a href="#Solution-2-Transparent-Proxy" class="headerlink" title="Solution #2 - Transparent Proxy"></a>Solution #2 - Transparent Proxy</h3><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_03.png" title="Image 03"><p>This solution implements the same collection of capabilities. However, with a very different approach: each microservice has a specific component, playing a proxy role, taking care of its incoming and outcoming traffic. The proxy solves the library drawbacks we described before as follows:</p><ul><li>The proxy is transparent, meaning the microservice is not aware it is running nearby and implementing all needed capabilities to communicate with other microservices.</li><li>Since it’s a transparent proxy, the developer doesn’t need to change the code to refer to the proxy. Therefore, upgrading the proxy would be a low-impact process from a microservice development perspective.</li><li>The proxy can be developed using different technologies and programming languages used by microservice.</li></ul><p><strong>The Service Mesh Architectural Pattern</strong></p><p>While a transparent proxy approach brings several benefits to the microservice development team and the microservice communication requirements, there are still some missing parts:</p><ul><li>The proxy is just enforcing policies to implement the communication requirements like load balancing, canary, etc.</li><li>What is responsible for defining such policies and publishing them across all running proxies?</li></ul><p>The solution architecture needs another component. Such components would be used by admins for policy definition and it will be responsible for broadcasting the policies to the proxies.</p><p>The following diagram shows the final architecture which is the service mesh pattern:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_04.png" title="Image 04"><p>As you can see, the pattern comprehends the two main components we’ve described:</p><ul><li>The data plane: also known as sidecar, it plays the transparent proxy role. Again, each microservice will have its own data plane intercepting all incoming and outgoing traffic and applying the policies previously described.</li><li>The control plane: used by the admin to define policies and publish them to the data plane.</li></ul><p>Some important things to note:</p><ul><li>It’s “push-based” architecture. The data plane doesn’t do “callouts” to get the policies: that would be a big network consuming architecture.</li><li>The data plane usually reports usage metrics to the control plane or a specific infrastructure.</li></ul><h2 id="Get-Hands-On-with-Rancher-Kong-and-Kong-Mesh"><a href="#Get-Hands-On-with-Rancher-Kong-and-Kong-Mesh" class="headerlink" title="Get Hands-On with Rancher, Kong and Kong Mesh"></a>Get Hands-On with Rancher, Kong and Kong Mesh</h2><p>Kong provides an enterprise-class and comprehensive service connectivity platform that includes an API gateway, a Kubernetes ingress controller and a Service Mesh implementation. The platform allows customers to deploy on multiple environments such as on premises, hybrid, multi-­­­­­­region and multi-cloud.</p><p>Let’s implement a Service Mesh with a canary release running on a cloud-agnostic Kubernetes cluster, which could include a Google Kubernetes Engine (GKE) cluster or any other Kubernetes distribution. The Service Mesh will be implemented by Kong Mesh (and protected by <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Kong/kubernetes-ingress-controller">Kong for Kubernetes</a> as the Kubernetes ingress controller. Generically speaking, the ingress controller is responsible for defining entry points to your Kubernetes cluster, exposing the microservices deployed inside of it and applying consumption policies to it.</p><p>First of all, make sure you have <a target="_blank" rel="noopener external nofollow noreferrer" href="https://rancher.com/docs/rancher/v2.x/en/installation/">Rancher</a> installed, as well as a Kubernetes cluster running and managed by Rancher. After logging into Rancher, choose the Kubernetes cluster we’re going to work on – in our case “kong-rancher”. Click the <strong>Cluster Explorer</strong> link. You will be redirected to a page like this:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_05.png" title="Image 05"><p>Now, let’s start with the Service Mesh:</p><ol><li><p>Kong Mesh Helm Chart</p><p>Go back to Rancher Cluster Manager home page and choose your cluster again. To add a new catalog, pass your mouse over the “Tools” menu option and click on <strong>Catalogs</strong>. Click the <strong>Add Catalog</strong> button and include <a target="_blank" rel="noopener external nofollow noreferrer" href="https://kong.github.io/kong-mesh-charts">Kong Mesh’s Helm v3 charts</a> .</p><p>Choose <strong>global</strong> as the scope and <strong>Helm v3</strong> as the Helm version.</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_06.png" title="Image 06"><p>Now click on <strong>Apps</strong> and <strong>Launch</strong> to see Kong Mesh available in the Catalog. Notice that Kong, as a Rancher partner, provides Kong for Kubernetes Helm Charts, by default:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_07.png" title="Image 07"></li><li><p>Install Kong Mesh</p><p>Click on the top menu option <strong>Namespaces</strong> and create a “kong-mesh-system” namespace.</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_08.png" title="Image 08"><p>Pass your mouse over the <strong>kong-rancher</strong> top menu option and click on <strong>kong-rancher active cluster</strong>.</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_09.png" title="Image 09"><p>Click on <strong>Launch kubectl</strong></p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_10.png" title="Image 10"><p>Create a file named “license.json” for the Kong Mesh license you received from Kong. The license follows the format:</p><p>{“license”:{“version”:1,“signature”:“6a7c81af4b0a42b380be25c2816a2bb1d761c0f906ae884f93eeca1fd16c8b5107cb6997c958f45d247078ca50a25399a5f87d546e59ea3be28284c3075a9769”,“payload”:{“customer”:“Kong_SE_Demo_H1FY22”,“license_creation_date”:“2020-11-30”,“product_subscription”:“Kong Enterprise Edition”,“support_plan”:“None”,“admin_seats”:“5”,“dataplanes”:“5”,“license_expiration_date”:“2021-06-30”,“license_key”:“XXXXXXXXXXXXX”}}}</p><p>Now, create a Kubernetes generic secret with the following command:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">secret</span> <span class="string">generic</span> <span class="string">kong-mesh-license</span> <span class="string">-n</span> <span class="string">kong-mesh-system</span> <span class="string">--from-file=./license.json</span></span><br></pre></td></tr></table></figure><p>Close the kubectl session, click on <strong>Default</strong> project and on <strong>Apps</strong> top menu option. Click on <strong>Launch</strong> button and choose the <strong>kong-mesh</strong> Helm charts.</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_11.png" title="Image 11"><p>Click on <strong>Use an existing namespace</strong> and choose the one we just created. There are <a target="_blank" rel="noopener external nofollow noreferrer" href="https://artifacthub.io/packages/helm/kong-mesh/kong-mesh">several parameters</a> to configure Kong Mesh, but we’re going to keep all the default values. After clicking on <strong>Launch</strong> , you should see the Kong Mesh application deployed:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_12.png" title="Image 12"><p>And you can check the installation using Rancher Cluster Explorer again. Click on <strong>Pods</strong> on the left menu and choose <strong>kong-mesh-system</strong> namespace:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_13.png" title="Image 13"><p>You can use kubectl as well like this:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">NAMESPACE</span>          <span class="string">NAME</span>                                                      <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">cattle-system</span>      <span class="string">cattle-cluster-agent-785fd5f54d-r7x8r</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">75m</span></span><br><span class="line"><span class="string">fleet-system</span>       <span class="string">fleet-agent-77c78f9c74-f97tv</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">75m</span></span><br><span class="line"><span class="string">kong-mesh-system</span>   <span class="string">kuma-control-plane-5b9c6f4598-nvq8q</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">16m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">event-exporter-gke-666b7ffbf7-n9lfl</span>                       <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">fluentbit-gke-xqsdv</span>                                       <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">gke-metrics-agent-gjrqr</span>                                   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">konnectivity-agent-4c4hf</span>                                  <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-dns-66d6b7c877-tq877</span>                                 <span class="number">4</span><span class="string">/4</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-dns-autoscaler-5c78d65cd9-5hcxs</span>                      <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-proxy-gke-c-kpwnf-default-0-be059c1c-49qp</span>            <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">l7-default-backend-5b76b455d-v6dvg</span>                        <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">metrics-server-v0.3.6-547dc87f5f-qntjf</span>                    <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">75m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">prometheus-to-sd-fdf9j</span>                                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">stackdriver-metadata-agent-cluster-level-68d94db6-64n4r</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="string">75m</span></span><br></pre></td></tr></table></figure></li><li><p>Microservices deployment</p><p>Our Service Mesh deployment is based on a simple microservice-to-microservice communication scenario. As we’re running a canary release, the called microservice has two versions.</p><ul><li>“magnanimo”: exposed through Kong for Kubernetes ingress controller.</li><li>“benigno”: provides a “hello” endpoint where it echoes the current datetime. It has a canary release that sends a slightly different response.</li></ul><p>The figure below illustrates the architecture:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_14.png" title="Image 14"><p>Create a namespace with the sidecar injection annotation. You can use the Rancher Cluster Manager again: choose your cluster and click on <strong>Projects&#x2F;Namespaces</strong>. Click on <strong>Add Namespace</strong>. Type “kong-mesh-app” for name and include an annotation with a “kuma.io&#x2F;sidecar-injection” key and “enabled” as its value:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_15.png" title="Image 15"><p>Again, you can use kubectl as an alternative</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">namespace</span> <span class="string">kong-mesh-app</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">annotate</span> <span class="string">namespace</span> <span class="string">kong-mesh-app</span> <span class="string">kuma.io/sidecar-injection=enabled</span></span><br><span class="line"></span><br><span class="line"><span class="string">Submit</span> <span class="string">the</span> <span class="string">following</span> <span class="string">declaration</span> <span class="string">to</span> <span class="string">deploy</span> <span class="string">Magnanimo</span> <span class="string">injecting</span> <span class="string">the</span> <span class="string">Kong</span> <span class="string">Mesh</span> <span class="string">data</span> <span class="string">plane</span></span><br><span class="line"></span><br><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">magnanimo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">kong-mesh-app</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">selector:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">matchLabels:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">magnanimo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">template:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">magnanimo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">magnanimo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">image:</span> <span class="string">claudioacquaviva/magnanimo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">magnanimo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">kong-mesh-app</span></span><br><span class="line"></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">magnanimo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">port:</span> <span class="number">4000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">http</span></span><br><span class="line"></span><br><span class="line"><span class="attr">selector:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">magnanimo</span></span><br><span class="line"></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>Check your deployment using Rancher Cluster Manager. Pass the mouse over the <strong>kong-rancher</strong> menu and click on the <strong>Default</strong> project to see the current deployments:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_16.png" title="Image 16"><p>Click on <strong>magnanimo</strong> to check details of the deployment, including its pods:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_17.png" title="Image 17"><p>Click on the <strong>magnanimo</strong> pod to check the containers running inside of it.</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_18.png" title="Image 18"><p>As we can see, the pod has two running containers:</p><ul><li>magnanimo: where the microservice is actually running</li><li>kuma-sidecar: injected during deployment time, playing the Kong Mesh data plane role.</li></ul><p>Similarly, deploy Benigno with its own sidecar:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">benigno-v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">kong-mesh-app</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">selector:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">matchLabels:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">benigno</span></span><br><span class="line"></span><br><span class="line"><span class="attr">template:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">benigno</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">benigno</span></span><br><span class="line"></span><br><span class="line"><span class="attr">image:</span> <span class="string">claudioacquaviva/benigno</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">benigno</span></span><br><span class="line"></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">kong-mesh-app</span></span><br><span class="line"></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">benigno</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">http</span></span><br><span class="line"></span><br><span class="line"><span class="attr">selector:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">benigno</span></span><br><span class="line"></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">And</span> <span class="string">finally,</span> <span class="attr">deploy Benigno canary release. Notice that the canary release will be abstracted by the same Benigno Kubernetes Service created before:</span></span><br><span class="line"></span><br><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">benigno-v2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">kong-mesh-app</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">selector:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">matchLabels:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">benigno</span></span><br><span class="line"></span><br><span class="line"><span class="attr">template:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">benigno</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">benigno</span></span><br><span class="line"></span><br><span class="line"><span class="attr">image:</span> <span class="string">claudioacquaviva/benigno\_rc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>Check the deployments and pods with:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">--all-namespaces</span></span><br><span class="line"><span class="string">NAMESPACE</span>          <span class="string">NAME</span>                                                      <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">cattle-system</span>      <span class="string">cattle-cluster-agent-785fd5f54d-r7x8r</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">75m</span></span><br><span class="line"><span class="string">fleet-system</span>       <span class="string">fleet-agent-77c78f9c74-f97tv</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">75m</span></span><br><span class="line"><span class="string">kong-mesh-app</span>      <span class="string">benigno-v1-fd4567d95-drnxq</span>                                <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">110s</span></span><br><span class="line"><span class="string">kong-mesh-app</span>      <span class="string">benigno-v2-b977c867b-lpjpw</span>                                <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">30s</span></span><br><span class="line"><span class="string">kong-mesh-app</span>      <span class="string">magnanimo-658b67fb9b-tzsjp</span>                                <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">5m3s</span></span><br><span class="line"><span class="string">kong-mesh-system</span>   <span class="string">kuma-control-plane-5b9c6f4598-nvq8q</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">16m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">event-exporter-gke-666b7ffbf7-n9lfl</span>                       <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">fluentbit-gke-xqsdv</span>                                       <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">gke-metrics-agent-gjrqr</span>                                   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">konnectivity-agent-4c4hf</span>                                  <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-dns-66d6b7c877-tq877</span>                                 <span class="number">4</span><span class="string">/4</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-dns-autoscaler-5c78d65cd9-5hcxs</span>                      <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-proxy-gke-c-kpwnf-default-0-be059c1c-49qp</span>            <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">l7-default-backend-5b76b455d-v6dvg</span>                        <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">metrics-server-v0.3.6-547dc87f5f-qntjf</span>                    <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">75m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">prometheus-to-sd-fdf9j</span>                                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">stackdriver-metadata-agent-cluster-level-68d94db6-64n4r</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="string">75m</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">service</span> <span class="string">--all-namespaces</span></span><br><span class="line"><span class="string">NAMESPACE</span>          <span class="string">NAME</span>                   <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>    <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                                                <span class="string">AGE</span></span><br><span class="line"><span class="string">default</span>            <span class="string">kubernetes</span>             <span class="string">ClusterIP</span>   <span class="number">10.0</span><span class="number">.16</span><span class="number">.1</span>     <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">/TCP</span>                                                <span class="string">79m</span></span><br><span class="line"><span class="string">kong-mesh-app</span>      <span class="string">benigno</span>                <span class="string">ClusterIP</span>   <span class="number">10.0</span><span class="number">.20</span><span class="number">.52</span>    <span class="string">&lt;none&gt;</span>        <span class="number">5000</span><span class="string">/TCP</span>                                               <span class="string">4m6s</span></span><br><span class="line"><span class="string">kong-mesh-app</span>      <span class="string">magnanimo</span>              <span class="string">ClusterIP</span>   <span class="number">10.0</span><span class="number">.30</span><span class="number">.251</span>   <span class="string">&lt;none&gt;</span>        <span class="number">4000</span><span class="string">/TCP</span>                                               <span class="string">7m18s</span></span><br><span class="line"><span class="string">kong-mesh-system</span>   <span class="string">kuma-control-plane</span>     <span class="string">ClusterIP</span>   <span class="number">10.0</span><span class="number">.21</span><span class="number">.228</span>   <span class="string">&lt;none&gt;</span>        <span class="number">5681</span><span class="string">/TCP,5682/TCP,443/TCP,5676/TCP,5678/TCP,5653/UDP</span>   <span class="string">18m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">default-http-backend</span>   <span class="string">NodePort</span>    <span class="number">10.0</span><span class="number">.19</span><span class="number">.10</span>    <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:32296/TCP</span>                                           <span class="string">79m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-dns</span>               <span class="string">ClusterIP</span>   <span class="number">10.0</span><span class="number">.16</span><span class="number">.10</span>    <span class="string">&lt;none&gt;</span>        <span class="number">53</span><span class="string">/UDP,53/TCP</span>                                          <span class="string">79m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">metrics-server</span>         <span class="string">ClusterIP</span>   <span class="number">10.0</span><span class="number">.20</span><span class="number">.174</span>   <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">/TCP</span>                                                <span class="string">79m</span></span><br></pre></td></tr></table></figure><p>You can use Kong Mesh console to check the microservices and data planes also. On a terminal run:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">port-forward</span> <span class="string">service/kuma-control-plane</span> <span class="string">-n</span> <span class="string">kong-mesh-system</span> <span class="number">5681</span></span><br></pre></td></tr></table></figure><p>Redirect your browser to <code>http://localhost:5681/gui</code>. Click on <strong>Skip to Dashboard</strong> and <strong>All Data Plane Proxies</strong> :</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_19.png" title="Image 19"><p>Start a loop to see the canary release in action. Notice the service has been deployed as ClusterIP type, so you need to expose them directly with “port-forward”. The next step will show how to expose the service with the Ingress Controller.</p><p>On a local terminal run:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">port-forward</span> <span class="string">service/magnanimo</span> <span class="string">-n</span> <span class="string">kong-mesh-app</span> <span class="number">4000</span></span><br></pre></td></tr></table></figure><p>Open another terminal and start the loop. The request is going to port 4000 provided by Magnanimo. The path “&#x2F;hw2” routes the request to Benigno Service, which has two endpoints behind it related to both Benigno releases:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">while</span> [<span class="number">1</span>]<span class="string">;</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">http://localhost:4000/hw2;</span> <span class="string">echo;</span> <span class="string">done</span></span><br></pre></td></tr></table></figure><p>You should see a result similar to this:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 12:57:05.811667</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 12:57:06.304731</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 12:57:06.789208</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 12:57:07.269674</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 12:57:07.755884</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 12:57:08.240453</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 12:57:08.728465</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 12:57:09.208588</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 12:57:09.689478</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 12:57:10.179551</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 12:57:10.662465</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 12:57:11.145237</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 12:57:11.618557</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 12:57:12.108586</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 12:57:12.596296</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 12:57:13.093329</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 12:57:13.593487</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 12:57:14.068870</span></span><br></pre></td></tr></table></figure></li><li><p>Controlling the Canary Release</p><p>As we can see, the request to both Benigno microservice releases is uses a round-robin policy. That is, we’re not in control of the canary release consumption. Service Mesh allows us to define when and how we want to expose the canary release to our consumers (in our case, the Magnanimo microservice).</p><p>To define a policy to control the traffic going to both releases, use this following declaration. It says that 90 percent of the traffic should go to the current release, while only 10 percent should be redirected to the canary release.</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kuma.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">TrafficRoute</span></span><br><span class="line"><span class="attr">mesh:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">route-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">sources:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line"><span class="attr">kuma.io/service:</span> <span class="string">magnanimo\_kong-mesh-app\_svc\_4000</span></span><br><span class="line"><span class="attr">destinations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line"><span class="attr">kuma.io/service:</span> <span class="string">benigno\_kong-mesh-app\_svc\_5000</span></span><br><span class="line"><span class="attr">conf:</span></span><br><span class="line"><span class="attr">split:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">90</span></span><br><span class="line"><span class="attr">destination:</span></span><br><span class="line"><span class="attr">kuma.io/service:</span> <span class="string">benigno\_kong-mesh-app\_svc\_5000</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">destination:</span></span><br><span class="line"><span class="attr">kuma.io/service:</span> <span class="string">benigno\_kong-mesh-app\_svc\_5000</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>After applying the declaration, you should see a result like this:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:02.553389</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:03.041120</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:03.532701</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:04.021804</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:04.515245</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 13:05:05.000644</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:05.482606</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:05.963663</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="string">Benigno,</span> <span class="attr">Canary Release:</span> <span class="number">2020-11-20 13:05:06.446599</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:06.926737</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:07.410605</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:07.890827</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:08.374686</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:08.857266</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:09.337360</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:09.816912</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:10.301863</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:10.782395</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:11.262624</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:11.743427</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:12.221174</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:12.705731</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:13.196664</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World,</span> <span class="attr">Benigno:</span> <span class="number">2020-11-20 13:05:13.680319</span></span><br></pre></td></tr></table></figure></li><li><p>Install Kong for Kubernetes</p><p>Let’s go back to Rancher to install our Kong for Kubernetes Ingress Controller and control the service mesh exposition. In the Rancher Catalog page, click the <strong>Kong</strong> icon. Accept the default values and click <strong>Launch</strong> :</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_20.png" title="Image 20"><p>You should see both applications, Kong and Kong Mesh, deployed:</p><img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_21.png" title="Image 21"> <img src="/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/kong_22.png" title="Image 22"><p>Again, check the installation with kubectl:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">--all-namespaces</span></span><br><span class="line"><span class="string">NAMESPACE</span>          <span class="string">NAME</span>                                                      <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">cattle-system</span>      <span class="string">cattle-cluster-agent-785fd5f54d-r7x8r</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">84m</span></span><br><span class="line"><span class="string">fleet-system</span>       <span class="string">fleet-agent-77c78f9c74-f97tv</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">83m</span></span><br><span class="line"><span class="string">kong-mesh-app</span>      <span class="string">benigno-v1-fd4567d95-drnxq</span>                                <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">10m</span></span><br><span class="line"><span class="string">kong-mesh-app</span>      <span class="string">benigno-v2-b977c867b-lpjpw</span>                                <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">8m47s</span></span><br><span class="line"><span class="string">kong-mesh-app</span>      <span class="string">magnanimo-658b67fb9b-tzsjp</span>                                <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">13m</span></span><br><span class="line"><span class="string">kong-mesh-system</span>   <span class="string">kuma-control-plane-5b9c6f4598-nvq8q</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">24m</span></span><br><span class="line"><span class="string">kong</span>               <span class="string">kong-kong-754cd6947-db2j9</span>                                 <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="string">72s</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">event-exporter-gke-666b7ffbf7-n9lfl</span>                       <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">85m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">fluentbit-gke-xqsdv</span>                                       <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">84m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">gke-metrics-agent-gjrqr</span>                                   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">84m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">konnectivity-agent-4c4hf</span>                                  <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">84m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-dns-66d6b7c877-tq877</span>                                 <span class="number">4</span><span class="string">/4</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">84m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-dns-autoscaler-5c78d65cd9-5hcxs</span>                      <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">84m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-proxy-gke-c-kpwnf-default-0-be059c1c-49qp</span>            <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">84m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">l7-default-backend-5b76b455d-v6dvg</span>                        <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">85m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">metrics-server-v0.3.6-547dc87f5f-qntjf</span>                    <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">84m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">prometheus-to-sd-fdf9j</span>                                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">84m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">stackdriver-metadata-agent-cluster-level-68d94db6-64n4r</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="string">84m</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">service</span> <span class="string">--all-namespaces</span></span><br><span class="line"><span class="string">NAMESPACE</span>          <span class="string">NAME</span>                   <span class="string">TYPE</span>           <span class="string">CLUSTER-IP</span>    <span class="string">EXTERNAL-IP</span>     <span class="string">PORT(S)</span>                                                <span class="string">AGE</span></span><br><span class="line"><span class="string">default</span>            <span class="string">kubernetes</span>             <span class="string">ClusterIP</span>      <span class="number">10.0</span><span class="number">.16</span><span class="number">.1</span>     <span class="string">&lt;none&gt;</span>          <span class="number">443</span><span class="string">/TCP</span>                                                <span class="string">85m</span></span><br><span class="line"><span class="string">kong-mesh-app</span>      <span class="string">benigno</span>                <span class="string">ClusterIP</span>      <span class="number">10.0</span><span class="number">.20</span><span class="number">.52</span>    <span class="string">&lt;none&gt;</span>          <span class="number">5000</span><span class="string">/TCP</span>                                               <span class="string">10m</span></span><br><span class="line"><span class="string">kong-mesh-app</span>      <span class="string">magnanimo</span>              <span class="string">ClusterIP</span>      <span class="number">10.0</span><span class="number">.30</span><span class="number">.251</span>   <span class="string">&lt;none&gt;</span>          <span class="number">4000</span><span class="string">/TCP</span>                                               <span class="string">13m</span></span><br><span class="line"><span class="string">kong-mesh-system</span>   <span class="string">kuma-control-plane</span>     <span class="string">ClusterIP</span>      <span class="number">10.0</span><span class="number">.21</span><span class="number">.228</span>   <span class="string">&lt;none&gt;</span>          <span class="number">5681</span><span class="string">/TCP,5682/TCP,443/TCP,5676/TCP,5678/TCP,5653/UDP</span>   <span class="string">24m</span></span><br><span class="line"><span class="string">kong</span>               <span class="string">kong-kong-proxy</span>        <span class="string">LoadBalancer</span>   <span class="number">10.0</span><span class="number">.26</span><span class="number">.38</span>    <span class="number">35.222</span><span class="number">.91</span><span class="number">.194</span>   <span class="number">80</span><span class="string">:31867/TCP,443:31039/TCP</span>                             <span class="string">78s</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">default-http-backend</span>   <span class="string">NodePort</span>       <span class="number">10.0</span><span class="number">.19</span><span class="number">.10</span>    <span class="string">&lt;none&gt;</span>          <span class="number">80</span><span class="string">:32296/TCP</span>                                           <span class="string">85m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">kube-dns</span>               <span class="string">ClusterIP</span>      <span class="number">10.0</span><span class="number">.16</span><span class="number">.10</span>    <span class="string">&lt;none&gt;</span>          <span class="number">53</span><span class="string">/UDP,53/TCP</span>                                          <span class="string">85m</span></span><br><span class="line"><span class="string">kube-system</span>        <span class="string">metrics-server</span>         <span class="string">ClusterIP</span>      <span class="number">10.0</span><span class="number">.20</span><span class="number">.174</span>   <span class="string">&lt;none&gt;</span>          <span class="number">443</span><span class="string">/TCP</span>                                                <span class="string">85m</span></span><br></pre></td></tr></table></figure></li><li><p>Ingress Creation</p><p>With the following declaration, we’re going to expose Magnanimo microservice through an Ingress and its route “&#x2F;route1”.</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">route1</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">kong-mesh-app</span></span><br><span class="line"><span class="attr">annotations:</span></span><br><span class="line"><span class="attr">konghq.com/strip-path:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line"><span class="attr">paths:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/route1</span></span><br><span class="line"><span class="attr">backend:</span></span><br><span class="line"><span class="attr">serviceName:</span> <span class="string">magnanimo</span></span><br><span class="line"><span class="attr">servicePort:</span> <span class="number">4000</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>Now the temporary “port-forward” exposure mechanism can be replaced by a formal Ingress. And our loop can start consuming the Ingress with similar results:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">while</span> [<span class="number">1</span>]<span class="string">;</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">http://35.222.91.194/route1/hw2;</span> <span class="string">echo;</span> <span class="string">done</span></span><br></pre></td></tr></table></figure></li></ol></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">IT老男孩</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://www.xtplayer.cn/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/">https://www.xtplayer.cn/service-mesh/using-hybrid-and-multi-cloud-service-mesh-based-applications-for-distributed-deployments/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a rel="noopener noreferrer" href="https://www.xtplayer.cn" target="_blank">IT老男孩</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/hci/announcing-harvester-open-source-hyperconverged-infrastructure-hci-software/"><img class="prev-cover" src="/img/gkihqEjXxJ5UZ1C.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Announcing Harvester - Open Source Hyperconverged Infrastructure (HCI) Software</div></div></a></div><div class="next-post pull-right"><a href="/k3s/set-up-k3s-in-high-availability-using-k3d/"><img class="next-cover" src="/img/gkihqEjXxJ5UZ1C.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Set up K3s in High Availability using k3d</div></div></a></div></nav><div class="ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4244806813321801" data-ad-slot="9845679202" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpeg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' width="110px" height="110px" alt="avatar"><div class="author-info__name">IT老男孩</div><div class="author-info__description">IT老男孩 - 原名系统玩家，分享 IT 相关技术文章，分享工作中的最佳实践。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">132</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">96</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/rancher"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xiaoluhong" target="_blank" rel="external nofollow noreferrer noopener" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1044281310@qq.com" target="_blank" rel="external nofollow noreferrer noopener" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">我的博客</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录导航</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Microservices-Dynamics-and-Intrinsic-Challenges"><span class="toc-number">1.</span> <span class="toc-text">Microservices Dynamics and Intrinsic Challenges</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Potential-Solutions"><span class="toc-number">2.</span> <span class="toc-text">Potential Solutions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-1-Encapsulating-all-capabilities-in-a-library"><span class="toc-number">2.1.</span> <span class="toc-text">Solution #1 - Encapsulating all capabilities in a library</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-2-Transparent-Proxy"><span class="toc-number">2.2.</span> <span class="toc-text">Solution #2 - Transparent Proxy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Get-Hands-On-with-Rancher-Kong-and-Kong-Mesh"><span class="toc-number">3.</span> <span class="toc-text">Get Hands-On with Rancher, Kong and Kong Mesh</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/rancher/waiting-for-node-to-register-either-cluster-is-not-ready-for-registering-or-etcd-and-controlplane-node-have-to-be-registered-first/" title="Waiting for node to register. Either cluster is not ready for registering or etcd and controlplane node have to be registered first">Waiting for node to register. Either cluster is not ready for registering or etcd and controlplane node have to be registered first</a><time datetime="2022-09-17T06:33:50.000Z" title="发表 2022-09-17 14:33:50">2022-09-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/mysql/how-to-get-the-sizes-of-the-tables-of-a-mysql-database/" title="如何查看 MySQL 数据库容量大小，表容量大小，索引容量大小？">如何查看 MySQL 数据库容量大小，表容量大小，索引容量大小？</a><time datetime="2022-05-17T08:48:50.000Z" title="发表 2022-05-17 16:48:50">2022-05-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/rancher/either-cluster-is-not-ready-for-registering/" title="node-agent 报错 Either cluster is not ready for registering, cluster is currently provisioning, or etcd, controlplane and worker node have to be registered">node-agent 报错 Either cluster is not ready for registering, cluster is currently provisioning, or etcd, controlplane and worker node have to be registered</a><time datetime="2022-05-14T05:13:09.000Z" title="发表 2022-05-14 13:13:09">2022-05-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/prometheus/prometheus-adapter/" title="Prometheus Adapter 安装">Prometheus Adapter 安装</a><time datetime="2022-04-04T08:26:12.000Z" title="发表 2022-04-04 16:26:12">2022-04-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/prometheus/custom-parameter/" title="自定义集群监控参数">自定义集群监控参数</a><time datetime="2022-03-28T11:10:20.000Z" title="发表 2022-03-28 19:10:20">2022-03-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/rancher/rancher-new-forums/" title="全新论坛启用，Rancher 中文社区迈入新阶段">全新论坛启用，Rancher 中文社区迈入新阶段</a><time datetime="2022-03-25T13:16:03.000Z" title="发表 2022-03-25 21:16:03">2022-03-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/coredns/accelerate-external-domain-resolution/" title="coreDNS 加速外部域名解析">coreDNS 加速外部域名解析</a><time datetime="2021-07-17T05:12:27.000Z" title="发表 2021-07-17 13:12:27">2021-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/longhorn/ai-at-the-edge-with-k3s-nvidia-jetson-nano-object-detection-real-time-video-analytics-src/" title="AI at the Edge with K3s and NVIDIA Jetson Nano: Object Detection and Real-Time Video Analytics">AI at the Edge with K3s and NVIDIA Jetson Nano: Object Detection and Real-Time Video Analytics</a><time datetime="2021-04-20T16:22:57.000Z" title="发表 2021-04-21 00:22:57">2021-04-21</time></div></div></div></div><div class="card-widget ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4244806813321801" data-ad-slot="5141213090" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By IT老男孩</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn"><img class="icp-icon" width="25px" height="17px" src="/img/icp.png" alt="icp"><span>蜀ICP备20023095号-1</span></a> <a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51010702002006"><span>川公网安备51010702002006号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text" aria-label="Search"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/instantpage.min.js" type="module"></script><script src="/js/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="5169987169" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><link rel="stylesheet" href="/css/APlayer.min.css" media="print" onload='this.media="all"'><script src="/js/APlayer.min.js"></script><script src="/js/Meting.min.js"></script><script src="/js/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!0,scrollRestoration:!1});document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","G-WDVQSZ43MX",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:send",(function(){if("object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="/js/busuanzi.pure.mini.js"></script><script>!function(){var e=document.createElement("script");e.src="https://sf1-scmcdn-tos.pstatp.com/goofy/ttzz/push.js?abca38a75f1ee646121b4cdefd4e13cef04782c449861f0dbdffcd879911999e0ea61db5c17bca91cb6b39891e5c5ae8de9c557b8186e0f895b49e96a4810ca7",e.id="ttzz";var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}(window)</script></div></body></html>