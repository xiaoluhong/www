<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Rancher 单节点安装迁移 HA 安装 | IT老男孩</title><meta name="keywords" content="IT老男孩,rancher,github rancher,rke,rke2,k3s,docker,kubernetes,devops,多集群管理,容器,Linux运维,网络运维,最佳实践,Rancher 单节点安装迁移 HA 安装,迁移,HA"><meta name="author" content="IT老男孩"><meta name="copyright" content="IT老男孩"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文永久链接: https:&#x2F;&#x2F;www.xtplayer.cn&#x2F;rancher&#x2F;backup-restore&#x2F;single-to-ha&#x2F;  Rancher 单节点安装 以下步骤创建用于演示迁移的 Rancher 单节点环境，如果您需要迁移正式环境可以跳过此步骤。   执行以下 docker 命令运行单个 Rancher Server 服务 docker run -d -p 8443:443 -p"><meta property="og:type" content="article"><meta property="og:title" content="Rancher 单节点安装迁移 HA 安装"><meta property="og:url" content="https://www.xtplayer.cn/rancher/backup-restore/single-to-ha/index.html"><meta property="og:site_name" content="IT老男孩"><meta property="og:description" content="本文永久链接: https:&#x2F;&#x2F;www.xtplayer.cn&#x2F;rancher&#x2F;backup-restore&#x2F;single-to-ha&#x2F;  Rancher 单节点安装 以下步骤创建用于演示迁移的 Rancher 单节点环境，如果您需要迁移正式环境可以跳过此步骤。   执行以下 docker 命令运行单个 Rancher Server 服务 docker run -d -p 8443:443 -p"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.xtplayer.cn/img/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2020-08-06T17:16:15.000Z"><meta property="article:modified_time" content="2021-03-23T14:58:20.000Z"><meta property="article:author" content="IT老男孩"><meta property="article:tag" content="迁移"><meta property="article:tag" content="HA"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.xtplayer.cn/img/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" type="image/png" href="/img/favicon.png"><link rel="canonical" href="https://www.xtplayer.cn/rancher/backup-restore/single-to-ha/"><link rel="preconnect" href="https//cdn.jsdelivr.net"><link rel="preconnect" href="https//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="https//hm.baidu.com"><link rel="preconnect" href="https//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet preload" as="font" href="/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="/css/snackbar.min.css" media="print" onload='this.media="all"'><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4244806813321801",enable_page_level_ads:"true"})</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?08d495d3996be233cf4355e47874fd02";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-WDVQSZ43MX"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WDVQSZ43MX")</script><script>!function(){var c=document.createElement("script");c.src="https://sf1-scmcdn-tos.pstatp.com/goofy/ttzz/push.js?abca38a75f1ee646121b4cdefd4e13ce89e669412cb977bb98b66029e7fc3cfc8d38a1f1352cfca035e8cdfca27dc395b6c71280cecfa54b697791769b400b8d",c.id="ttzz";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(c,e)}(window)</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-center"},source:{jQuery:"/js/jquery.min.js",justifiedGallery:{js:"/js/jquery.justifiedGallery.min.js",css:"/css/justifiedGallery.min.css"},fancybox:{js:"/js/jquery.fancybox.min.js",css:"/css/jquery.fancybox.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isanchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2021-03-23 22:58:20"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)});const t=saveToLocal.get("aside-status");void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"))})(window)</script><style>#toggle-sidebar{left:100px}</style><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="IT老男孩" type="application/atom+xml"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpeg" onerror='onerror=null,src="/img/friend_404.gif"' width="110px" height="110px" alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">132</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">96</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div><div class="menus_item"><a class="site-page" href="/ad/"><i class="fa-fw fas fa-heart"></i> <span>广告</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">IT老男孩</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div><div class="menus_item"><a class="site-page" href="/ad/"><i class="fa-fw fas fa-heart"></i> <span>广告</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div class="ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4244806813321801" data-ad-slot="4594418186" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div id="post-info"><h1 class="post-title">Rancher 单节点安装迁移 HA 安装</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表:</span> <time class="post-meta-date-created" datetime="2020-08-06T17:16:15.000Z" title="发表 2020-08-07 01:16:15">2020-08-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新:</span> <time class="post-meta-date-updated" datetime="2021-03-23T14:58:20.000Z" title="更新 2021-03-23 22:58:20">2021-03-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><span class="post-meta-label">分类:</span> <a class="post-meta-categories" href="/categories/rancher/">rancher</a><i class="fas fa-angle-right post-meta-separator"></i><a class="post-meta-categories" href="/categories/rancher/backup-restore/">backup-restore</a></span><span class="post-meta tags"><span class="post-meta-separator">|</span><i class="fas fa-tag post-meta-icon"></i><span class="post-meta-label">标签:</span> <a class="post-meta-tags" href="/tags/%E8%BF%81%E7%A7%BB/">迁移</a><span class="post-meta__link">•</span><a class="post-meta-tags" href="/tags/ha/">HA</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span> <span class="word-count">1.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span> <span>4分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="Rancher 单节点安装迁移 HA 安装"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><p><span>本文永久链接:</span><i class="fa fa-creative-commons"></i> <a rel="noopener external nofollow noreferrer" href="https://www.xtplayer.cn/rancher/backup-restore/single-to-ha/" target="_blank" title="https://www.xtplayer.cn/rancher/backup-restore/single-to-ha/">https://www.xtplayer.cn/rancher/backup-restore/single-to-ha/</a></p><h2 id="Rancher-单节点安装"><a href="#Rancher-单节点安装" class="headerlink" title="Rancher 单节点安装"></a>Rancher 单节点安装</h2><blockquote><p>以下步骤创建用于演示迁移的 Rancher 单节点环境，如果您需要迁移正式环境可以跳过此步骤。</p></blockquote><ol><li><p>执行以下 docker 命令运行单个 Rancher Server 服务</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d -p 8443:443 -p 8880:80 -v /home/rancher/:/var/lib/rancher/rancher/rancher:v2.3.0</span><br></pre></td></tr></table></figure></li><li><p>等容器初始化完成后，通过节点 IP 访问 Rancher Server UI，设置密码并登录。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016142653127.bfb75310.png" title="image-20191016142653127"> <img src="/rancher/backup-restore/single-to-ha/image-20191016142719866.e60dc1cc.png" title="image-20191016142719866"></li></ol><h2 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h2><blockquote><p>以下步骤创建用于演示的业务集群，用来验证 Rancher 单节点安装迁移到 HA 后数据是否丢失，如果您需要迁移正式环境可以跳过此步骤。</p></blockquote><ol><li><p>登录 Rancher UI 后，添加一个自定义集群</p><img src="/rancher/backup-restore/single-to-ha/image-20191016142808830.c72a486a.png" title="image-20191016142808830"></li><li><p>授权集群访问地址 设置为启用，FQDN 和证书可以不用填写。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016142850886.ba5a2e45.png" title="image-20191016142850886"><blockquote><p>警告：这一步很关键。如果 Rancher 切换到 HA 后，因为地址或者 token 或者证书的变更，将会导致 Agent 无法连接 Rancher Server。在迁移到 HA 后，需要通过 kubectl 去编辑配置文件更新一些 Agent 相关的参数。默认 UI 上的 kube 配置文件是通过 Agent 代理连接到 K8S，如果 Agent 无法连接 Rancher Server，则通过这个 KUBE 配置文件无法访问 K8S 集群。开启授权集群访问地址功能会生成多个 Contexts Cluster，这些 Contexts Cluster 是直连 K8S，不通过 Agent 代理。如果业务集群未开启这个功能，可以通过编辑集群来开启这个功能。</p></blockquote></li><li><p>点击 下一步 ，根据预先分配的节点角色选择需要的角色，然后复制命令到主机终端执行。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016143133778.eb4ca75c.png" title="image-20191016143133778"></li><li><p>集群部署完成后，进入集群首页，点击 <code>kubeconfig 文件</code>按钮。在弹窗页面中复制 kubeconfg 配置文件到文本编辑备用。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016143513361.5a28d714.png" title="image-20191016143513361"> <img src="/rancher/backup-restore/single-to-ha/image-20191016143636998.5937b767.png" title="image-20191016143636998"></li></ol><h2 id="部署测试应用"><a href="#部署测试应用" class="headerlink" title="部署测试应用"></a>部署测试应用</h2><ol><li><p>进入 default 项目，随意部署一个测试应用。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016143950402.f80b226b.png" title="image-20191016143950402"></li><li><p>进入应用商店，部署一个测试应用。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016144352807.226b19e3.png" title="image-20191016144352807"></li></ol><h2 id="备份-Rancher-数据"><a href="#备份-Rancher-数据" class="headerlink" title="备份 Rancher 数据"></a>备份 Rancher 数据</h2><p>执行 <code>docker exec -ti &lt;Containers_ID&gt; bash</code> 进入 Rancher Server 容器，然后执行 <code>etcdctl snapshot save /var/lib/rancher/snapshot.db</code> 进行数据备份。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016144702116.b41e358f.png" title="image-20191016144702116"><p>因为 <code>/var/lib/rancher/</code> 是映射到主机的 <code>/home/rancher/</code> 目录，所以备份的数据可以直接在主机的&#x2F;home&#x2F;rancher&#x2F;下获取。</p><h2 id="ETCD-数据恢复"><a href="#ETCD-数据恢复" class="headerlink" title="ETCD 数据恢复"></a>ETCD 数据恢复</h2><ol><li><p>将 Rancher 备份文件拷贝到需要部署 Rancher HA 的主机上，比如放在 <code>/home/</code> 目录，所有节点都要拷贝。如果节点之前安装过 K8S 集群，请确保节点已经初始化过（了解<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.rancher.cn/docs/rancher/v2.x/cn/install-prepare/remove-node/">节点清理</a>）。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016145903388.e27b4dad.png" title="image-20191016145903388"></li><li><p>获取 etcdctl</p><p>访问 <code>https://github.com/etcd-io/etcd/releases/</code> 下载 ETCD 二进制压缩包，解压后获得 etcdctl 二进制文件。拷贝 etcdctl 二进制文件到 Rancher HA 的主机上。并给文件可执行权限 <code>chmod +x etcdctl</code>。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016150137910.d1a12c57.png" title="image-20191016150137910"></li><li><p>在 Rancher HA 所有节点执行以下命令将 ETCD 备份文件恢复到默认路径</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NODE_IP=<span class="string">&#x27;&#x27;</span> (当前节点 ip)</span><br><span class="line">ETCD_NAME=$( <span class="built_in">echo</span> etcd-$( <span class="built_in">echo</span> <span class="variable">$NODE_IP</span> | sed <span class="string">&#x27;s/\./-/g&#x27;</span> ) )</span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;<span class="subst">$( echo $ETCD_NAME=https://$&#123;NODE_IP&#125;:2380 )</span>&quot;</span></span><br><span class="line"></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot restore xxxxxxxxx \</span><br><span class="line">--data-dir=<span class="string">&quot;/var/lib/etcd&quot;</span> \</span><br><span class="line">--initial-cluster=<span class="variable">$&#123;ETCD_INITIAL_CLUSTER&#125;</span> \</span><br><span class="line">--initial-advertise-peer-urls=<span class="string">&quot;https://<span class="variable">$&#123;NODE_IP&#125;</span>:2380&quot;</span></span><br></pre></td></tr></table></figure><img src="/rancher/backup-restore/single-to-ha/image-20191016150556120.8d31391b.png" title="image-20191016150556120"><p>以上操作将把数据恢复到 ETCD 默认存储路径。</p></li></ol><h2 id="LOCAL-K8S-集群部署"><a href="#LOCAL-K8S-集群部署" class="headerlink" title="LOCAL K8S 集群部署"></a>LOCAL K8S 集群部署</h2><ol><li><p>根据文档<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.rancher.cn/docs/rke/latest/cn/example-yamls/">示例配置</a> 创建 RKE 配置文件。</p></li><li><p>执行 rke 命令创建 LOCAL K8S 集群</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rke up --config cluster.yml</span><br></pre></td></tr></table></figure><img src="/rancher/backup-restore/single-to-ha/image-20191016152133693.57f266c1.png" title="image-20191016152133693"></li><li><p>检查 K8S 集群运行状态</p><img src="/rancher/backup-restore/single-to-ha/image-20191016165114635.b64d8ccf.png" title="image-20191016165114635"> <img src="/rancher/backup-restore/single-to-ha/image-20191016165143557.52caeb15.png" title="image-20191016165143557"></li></ol><h2 id="Rancher-HA-安装"><a href="#Rancher-HA-安装" class="headerlink" title="Rancher HA 安装"></a>Rancher HA 安装</h2><blockquote><p>警告: Rancher HA 的版本需要大于或者等于 Rancher 单节点的版本。</p></blockquote><ol><li><p>根据<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.rancher.cn/docs/rancher/v2.x/cn/install-prepare/self-signed-ssl/">自签名 ssl 证书</a>文档创建自签名证书或者配置权威证书；</p></li><li><p>根据<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.rancher.cn/docs/rancher/v2.x/cn/installation/">安装文档</a>进行 Rancher HA 安装；</p></li><li><p>安装完成后访问 Rancher UI，可以看到之前添加的 <code>test</code> 集群。（错误提示是因为 Rancher URL 改变，cluster Agent 无法连接 Rancher Server。）</p><img src="/rancher/backup-restore/single-to-ha/image-20191016170347456.6c38e55d.png" title="image-20191016170347456"></li></ol><h2 id="Rancher-HA-配置"><a href="#Rancher-HA-配置" class="headerlink" title="Rancher HA 配置"></a>Rancher HA 配置</h2><ol><li><p>修改 Rancher URL 配置</p><p>在<code>全局|系统设置</code>中找到 <code>server-url</code>，如果 Rancher HA 地址与 Rancher 单节点地址不一致，则修改地址为 Rancher HA 地址。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016170849825.bb6a9895.png" title="image-20191016170849825"></li><li><p>然后新开窗口，在浏览器地址栏输入 <code>https://rancher-url/v3/clusters/local/clusterregistrationtokens</code> 切换到注册命令接口页面。</p></li><li><p>在注册命令接口页找到 <code>insecureCommand</code> 字段，复制字段后面的 yaml 文件链接。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016185613510.4936d731.png" title="image-20191016185613510"></li><li><p>通过命令 <code>curl -o local.yaml https://192.168.3.115:30303/v3/import/8vvmfwjwd6mkf8g2f769cnhh4s64s5jcnxgv5t6v5bdxk84tf6zztl.yaml</code> 把文件下载到本地，文件名建议以集群 ID 命名，用于区分。</p></li><li><p>相应的，其他业务集群也需要按照以上步骤，通过访问 <code>https://&lt;rancher_url&gt;/v3/clusters/&lt;cluster_id&gt;/clusterregistrationtokens</code> 去获取 <code>insecureCommand</code> 对应的 <code>yaml</code> 文件，然后下载 yaml 文件到本地。在切换到对应集群后，在地址栏可以看到 <code>&lt;cluster_id&gt;</code>。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016191846530.e09740ab.png" title="image-20191016191846530"><blockquote><p>在更换地址后，<code>clusterregistrationtokens</code> 接口中可能会生成多组 <code>insecureCommand</code>，如下图。对应的，在 <code>insecureCommand</code> 上方有 <code>createdTS</code> 字段，<code>createdTS</code> 数值越大，对应的 yaml 配置最新，请选择最大数值 <code>createdTS</code> 下的 <code>insecureCommand</code> 后的 <code>yaml</code> 链接。</p></blockquote><img src="/rancher/backup-restore/single-to-ha/image-20191017182734715.a45ec16f.png" title="image-20191017182734715"></li><li><p>根据前面步骤中保存的 kubecfg 配置文件，和上一步骤中保存的对应集群注册 <code>yaml 文件</code>，通过 kubectl 工具去执行。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--kubeconfig=xxxx <span class="comment"># 指定集群配置文件</span></span><br><span class="line">--context=xxxx  <span class="comment"># 切换授权集群访问地址（local 集群不用切换，local 集群配置默认是直连 K8S 集群）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># local 示例</span></span><br><span class="line">kubectl --kubeconfig=kube_config_cluster.yml apply -f local.yaml</span><br><span class="line"><span class="comment"># 业务集群示例</span></span><br><span class="line">kubectl --kubeconfig=kube_c-b49gh.yml --context test-node apply -f c-b49gh.yaml</span><br></pre></td></tr></table></figure></li><li><p>执行完以上命令后业务集群将自动连接 Rancher</p><img src="/rancher/backup-restore/single-to-ha/image-20191016195215819.13ff7ae2.png" title="image-20191016195215819"><p>之前部署的应用正常运行，未丢失。</p><img src="/rancher/backup-restore/single-to-ha/image-20191016195309268.eba42a2e.png" title="image-20191016195309268"></li></ol></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">IT老男孩</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://www.xtplayer.cn/rancher/backup-restore/single-to-ha/">https://www.xtplayer.cn/rancher/backup-restore/single-to-ha/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a rel="noopener noreferrer" href="https://www.xtplayer.cn" target="_blank">IT老男孩</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BF%81%E7%A7%BB/">迁移</a><a class="post-meta__tags" href="/tags/ha/">HA</a></div><div class="post_share"></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/rancher/password-reset/"><img class="prev-cover" src="/img/gkihqEjXxJ5UZ1C.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Rancher server 管理员密码重置</div></div></a></div><div class="next-post pull-right"><a href="/rancher/rotate-cert/"><img class="next-cover" src="/img/gkihqEjXxJ5UZ1C.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Rancher-K8S 轮换证书</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i> <span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/rancher/backup-restore/rancher-custom-cluster-backups/" title="rancher 自定义集群备份"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-10</div><div class="title">rancher 自定义集群备份</div></div></a></div><div><a href="/rancher/backup-restore/rancher-custom-cluster-restore/" title="rancher 自定义集群恢复"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-10</div><div class="title">rancher 自定义集群恢复</div></div></a></div><div><a href="/rancher/backup-restore/rancher-rke-cluster-backups/" title="rancher rke 集群备份"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-10</div><div class="title">rancher rke 集群备份</div></div></a></div><div><a href="/rancher/backup-restore/rancher-rke-cluster-restore/" title="rancher rke 集群恢复"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-10</div><div class="title">rancher rke 集群恢复</div></div></a></div><div><a href="/rancher/backup-restore/rancher-single-container-backups/" title="rancher 单容器安装备份"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-10</div><div class="title">rancher 单容器安装备份</div></div></a></div><div><a href="/rancher/backup-restore/rancher-single-container-restore/" title="rancher 单容器安装恢复"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-10</div><div class="title">rancher 单容器安装恢复</div></div></a></div><div><a href="/rancher/backup-restore/restore-rkestate/" title="恢复 rkestate 状态文件"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-04</div><div class="title">恢复 rkestate 状态文件</div></div></a></div><div><a href="/rancher/Rancher2.x-migrate-custom-k8s-cluster/" title="重磅出击: Rancher 2.4.x 迁移自定义 k8s 集群"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-04</div><div class="title">重磅出击: Rancher 2.4.x 迁移自定义 k8s 集群</div></div></a></div><div><a href="/rancher/cattle-global-data-system-library-rancher-monitoring-not-found/" title="cattle-global-data/system-library-rancher-monitoring not found"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-11</div><div class="title">cattle-global-data/system-library-rancher-monitoring not found</div></div></a></div><div><a href="/rancher/compute-confidently-at-the-edge-with-rancher-and-longhorn-1-1/" title="Compute Confidently at the Edge with Rancher and Longhorn"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-26</div><div class="title">Compute Confidently at the Edge with Rancher and Longhorn</div></div></a></div><div><a href="/rancher/import-k8s-cluster-update-ca/" title="导入 k8s 集群更新 CA 证书后 Rancher 端的配置操作"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-11</div><div class="title">导入 k8s 集群更新 CA 证书后 Rancher 端的配置操作</div></div></a></div><div><a href="/rancher/either-cluster-is-not-ready-for-registering/" title="node-agent 报错 Either cluster is not ready for registering, cluster is currently provisioning, or etcd, controlplane and worker node have to be registered"><img class="cover" src="/img/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-14</div><div class="title">node-agent 报错 Either cluster is not ready for registering, cluster is currently provisioning, or etcd, controlplane and worker node have to be registered</div></div></a></div></div></div><div class="ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4244806813321801" data-ad-slot="9845679202" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpeg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' width="110px" height="110px" alt="avatar"><div class="author-info__name">IT老男孩</div><div class="author-info__description">IT老男孩 - 原名系统玩家，分享 IT 相关技术文章，分享工作中的最佳实践。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">132</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">96</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/rancher"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xiaoluhong" target="_blank" rel="external nofollow noreferrer noopener" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1044281310@qq.com" target="_blank" rel="external nofollow noreferrer noopener" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">我的博客</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录导航</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Rancher-%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">Rancher 单节点安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="toc-number">2.</span> <span class="toc-text">创建集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%B5%8B%E8%AF%95%E5%BA%94%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">部署测试应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD-Rancher-%E6%95%B0%E6%8D%AE"><span class="toc-number">4.</span> <span class="toc-text">备份 Rancher 数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ETCD-%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D"><span class="toc-number">5.</span> <span class="toc-text">ETCD 数据恢复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LOCAL-K8S-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">6.</span> <span class="toc-text">LOCAL K8S 集群部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rancher-HA-%E5%AE%89%E8%A3%85"><span class="toc-number">7.</span> <span class="toc-text">Rancher HA 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rancher-HA-%E9%85%8D%E7%BD%AE"><span class="toc-number">8.</span> <span class="toc-text">Rancher HA 配置</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/rancher/waiting-for-node-to-register-either-cluster-is-not-ready-for-registering-or-etcd-and-controlplane-node-have-to-be-registered-first/" title="Waiting for node to register. Either cluster is not ready for registering or etcd and controlplane node have to be registered first">Waiting for node to register. Either cluster is not ready for registering or etcd and controlplane node have to be registered first</a><time datetime="2022-09-17T06:33:50.000Z" title="发表 2022-09-17 14:33:50">2022-09-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/mysql/how-to-get-the-sizes-of-the-tables-of-a-mysql-database/" title="如何查看 MySQL 数据库容量大小，表容量大小，索引容量大小？">如何查看 MySQL 数据库容量大小，表容量大小，索引容量大小？</a><time datetime="2022-05-17T08:48:50.000Z" title="发表 2022-05-17 16:48:50">2022-05-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/rancher/either-cluster-is-not-ready-for-registering/" title="node-agent 报错 Either cluster is not ready for registering, cluster is currently provisioning, or etcd, controlplane and worker node have to be registered">node-agent 报错 Either cluster is not ready for registering, cluster is currently provisioning, or etcd, controlplane and worker node have to be registered</a><time datetime="2022-05-14T05:13:09.000Z" title="发表 2022-05-14 13:13:09">2022-05-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/prometheus/prometheus-adapter/" title="Prometheus Adapter 安装">Prometheus Adapter 安装</a><time datetime="2022-04-04T08:26:12.000Z" title="发表 2022-04-04 16:26:12">2022-04-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/prometheus/custom-parameter/" title="自定义集群监控参数">自定义集群监控参数</a><time datetime="2022-03-28T11:10:20.000Z" title="发表 2022-03-28 19:10:20">2022-03-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/rancher/rancher-new-forums/" title="全新论坛启用，Rancher 中文社区迈入新阶段">全新论坛启用，Rancher 中文社区迈入新阶段</a><time datetime="2022-03-25T13:16:03.000Z" title="发表 2022-03-25 21:16:03">2022-03-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/coredns/accelerate-external-domain-resolution/" title="coreDNS 加速外部域名解析">coreDNS 加速外部域名解析</a><time datetime="2021-07-17T05:12:27.000Z" title="发表 2021-07-17 13:12:27">2021-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/longhorn/ai-at-the-edge-with-k3s-nvidia-jetson-nano-object-detection-real-time-video-analytics-src/" title="AI at the Edge with K3s and NVIDIA Jetson Nano: Object Detection and Real-Time Video Analytics">AI at the Edge with K3s and NVIDIA Jetson Nano: Object Detection and Real-Time Video Analytics</a><time datetime="2021-04-20T16:22:57.000Z" title="发表 2021-04-21 00:22:57">2021-04-21</time></div></div></div></div><div class="card-widget ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4244806813321801" data-ad-slot="5141213090" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By IT老男孩</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn"><img class="icp-icon" width="25px" height="17px" src="/img/icp.png" alt="icp"><span>蜀ICP备20023095号-1</span></a> <a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51010702002006"><span>川公网安备51010702002006号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text" aria-label="Search"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/instantpage.min.js" type="module"></script><script src="/js/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="5169987169" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><link rel="stylesheet" href="/css/APlayer.min.css" media="print" onload='this.media="all"'><script src="/js/APlayer.min.js"></script><script src="/js/Meting.min.js"></script><script src="/js/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!0,scrollRestoration:!1});document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","G-WDVQSZ43MX",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:send",(function(){if("object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="/js/busuanzi.pure.mini.js"></script><script>!function(){var e=document.createElement("script");e.src="https://sf1-scmcdn-tos.pstatp.com/goofy/ttzz/push.js?abca38a75f1ee646121b4cdefd4e13cef04782c449861f0dbdffcd879911999e0ea61db5c17bca91cb6b39891e5c5ae8de9c557b8186e0f895b49e96a4810ca7",e.id="ttzz";var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}(window)</script></div></body></html>